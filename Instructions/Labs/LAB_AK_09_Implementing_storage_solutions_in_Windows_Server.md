---
lab:
  title: 'ラボ: Windows Server での記憶域ソリューションの実装'
  type: Answer Key
  module: 'Module 9: File servers and storage management in Windows Server'
---

# <a name="lab-answer-key-implementing-storage-solutions-in-windows-server"></a>ラボの回答キー: Windows Server での記憶域ソリューションの実装

                **メモ:** このラボをご自分のペースでクリックして進めることができる、 **[ラボの対話型シミュレーション](https://mslabs.cloudguides.com/guides/AZ-800%20Lab%20Simulation%20-%20Implementing%20storage%20solutions%20in%20Windows%20Server)** が用意されています。 対話型シミュレーションとホストされたラボの間に若干の違いがある場合がありますが、示されている主要な概念とアイデアは同じです。 

> **注**: 各演習の間で、仮想マシン (VM) を必ず元に戻してください。 ほとんどの VM は Windows Server 2019 Server Core なので、演習で記憶域環境に行った変更を元に戻すより、VM を元に戻して再起動する方が時間がかかりません。

## <a name="exercise-1-implementing-data-deduplication"></a>演習 1: データ重複除去の実装

#### <a name="task-1-install-the-data-deduplication-role-service"></a>タスク 1: データ重複除去の役割サービスをインストールする

1. **SEA-ADM1** に接続し、必要であればパスワード **Pa55w.rd** を使用して **CONTOSO\\Administrator** としてサインインします。
1. **SEA-ADM1** で、**[スタート]** を選択し、**[サーバー マネージャー]** を選択します。
1. サーバー マネージャーで、**[管理]** を選択してから、**[役割と機能の追加]** を選択します。
1. **役割と機能の追加ウィザード**で、**[次へ]** を 2 回選択します。
1. **[対象サーバーの選択]** ページの [サーバープール] ペインで、**SEA-SVR3.Contoso.com** を選択してから、**[次へ]** を選択します。
1. **[サーバーの役割の選択]** ページの [役割] ペインで、**[ファイル サービスと記憶域サービス]** 項目を展開してから、**[ファイル サービスおよび iSCSI サービス]** 項目を展開し、**[データ重複除去]** 項目を選択して、**[次へ]** を選択します。
1. **[機能の選択]** ページで **[次へ]** を選択し、**[インストール オプションの確認]** ページで **[インストール]** を選択します。
1. 役割サービスのインストール中に、タスク バーでの **[エクスプローラー]** アイコンを選択します。
1. **エクスプローラー**で **C** ドライブを参照します。
1. **Labfiles** ディレクトリを選択し、状況依存のメニューを表示します。 メニューで **[アクセスを付与する対象]** を選択し、カスケードメニューで **[特定のユーザー]** を選択します。
1. **[ネットワーク アクセス]** ウィンドウの **[名前を入力して [追加] をクリックするか、または、矢印をクリックして相手を検索してください]** テキスト ボックスに「**Users**」と入力して、**[追加]** をクリックします。
1. **[ネットワーク アクセス]** ウィンドウで **[共有]** を選択し、**[ユーザーのフォルダーは共有されています]** ウィンドウが表示されたら、**[完了]** を選択します。
1. **[サーバー マネージャー]** ウィンドウに戻り、**[Add Roles and Features Wizard installation succeeded]\(役割と機能の追加ウィザードのインストールが成功しました\)** ページで **[閉じる]** を選択します。
1. **SEA-SVR3** のコンソール セッションに切り替え、必要に応じて、**Pa55w.rd** のパスワードを使用して **CONTOSO\\Administrator** としてサインインします。
1. **SConfig** のメニューが表示された場合は、**[選択するオプションの番号を入力してください]** で「**15**」と入力して Enter キーを押し、終了して **PowerShell** コンソール セッションに移動します。
1. **Windows PowerShell** のプロンプトで次のコマンドを入力してそれぞれの後で Enter キーを押して、ReFS でフォーマットされた新しいドライブを作成します。

   ```powershell
   Get-Disk
   Initialize-Disk -Number 1
   New-Partition -DiskNumber 1 -UseMaximumSize -DriveLetter M
   Format-Volume -DriveLetter M -FileSystem ReFS
   ```
1. **Windows PowerShell** のプロンプトで、次のコマンドを入力して Enter キーを押し、**SEA-ADM1** から重複除去するサンプル ファイルを作成するスクリプトをコピーして実行し、結果を確認します。

   ```powershell
   New-PSDrive –Name 'X' –PSProvider FileSystem –Root '\\SEA-ADM1\Labfiles'
   New-Item -Type Directory -Path 'M:\Data' -Force
   Copy-Item -Path X:\Lab09\CreateLabFiles.cmd -Destination M:\Data\ -PassThru
   Start-Process -FilePath M:\Data\CreateLabFiles.cmd -PassThru
   Set-Location -Path M:\Data
   Get-ChildItem -Path .
   Get-PSDrive -Name M
   ```

   > **注**: ドライブ **M** の空き領域を記録しておきます。 

#### <a name="task-2-enable-and-configure-data-deduplication"></a>タスク 2: データ重複除去を有効にして構成する

1. **SEA-ADM1** へのコンソール セッションに戻り、コンソール セッション内で**サーバー マネージャー**に切り替えます。
1. **サーバー マネージャー**のツリー ペインで、**[ファイル サービスと記憶域サービス]** を選択し、**[ディスク]** を選択します。
1. [ディスク] ペインで、**SEA-SVR3** のディスクの一覧を参照し、前のタスクで構成したディスク番号 **1** を表すエントリを選択します。
1. [ボリューム] ペインで、**M:** ボリュームの状況依存メニューを表示し、メニューの **[データ重複除去の構成]** を選択します。
1. **[ボリューム (M:\\) 重複除去設定]** ウィンドウの **[データ重複除去]** ドロップダウン リストのリストで、 **[汎用ファイル サーバー]** の設定を選択します。
1. **[次の期間経過したファイルを重複除去の対象とする (日数)]** テキストボックスで、既定値の **3** を **0** に変更します。
1. **[重複除去スケジュールの設定]** ボタンを選択します。
1. **[SVR3 重複除去スケジュール]** ウィンドウで、 **[スループットの最適化を有効にする]** を選択し、 **[OK]** を選択します。
1. **[ボリューム (M:\\) 重複除去設定]** ウィンドウに戻り、 **[OK]** を選択します。

#### <a name="task-3-test-data-deduplication"></a>タスク 3: データ重複除去をテストする

1. **SEA-ADM1** 上で **[スタート]** を選択し、**[Windows PowerShell (管理者)]** を選択します。

   >**注**: **SEA-ADM1** にまだ Windows Admin Center をインストールしていない場合は、次の 2 つの手順を実行します。

1. **Windows PowerShell** コンソールで、次のコマンドを入力してから Enter キーを押し、Windows Admin Center の最新バージョンをダウンロードします。
    
   ```powershell
   Start-BitsTransfer -Source https://aka.ms/WACDownload -Destination "$env:USERPROFILE\Downloads\WindowsAdminCenter.msi"
   ```
1. 次のコマンドを入力してから Enter キーを押して、Windows Admin Center をインストールします。
    
   ```powershell
   Start-Process msiexec.exe -Wait -ArgumentList "/i $env:USERPROFILE\Downloads\WindowsAdminCenter.msi /qn /L*v log.txt REGISTRY_REDIRECT_PORT_80=1 SME_PORT=443 SSL_CERTIFICATE_OPTION=generate"
   ```

   > **注**: インストールが完了するまで待ちます。 これには 2 分ほどかかります。

1. **SEA-ADM1** で Microsoft Edge を起動してから、`https://SEA-ADM1.contoso.com` に移動します。 
1. メッセージが表示されたら、**[Windows セキュリティ]** ダイアログ ボックスに次の資格情報を入力し、**[OK]** を選択します。

   - ユーザー名: **CONTOSO\\Administrator**
   - パスワード: **Pa55w.rd**

1. [すべての接続] ペインで、**[+ 追加]** を選択します。
1. リソースの追加または作成ペインの **[サーバー]** タイルで、**[追加]** を選択します。
1. **[サーバー名]** テキスト ボックスに、「**sea-svr3.contoso.com**」と入力します。 
1. 必要に応じて、**[Use another account for this connection]\(この接続に別のアカウントを使用する\)** オプションが選択されていることを確認し、次の資格情報を入力して、**[Add with credentials]\(資格情報を使用して追加\)** を選択します。

   - ユーザー名: **CONTOSO\\Administrator**
   - パスワード: **Pa55w.rd**

1. **sea-svr3.contoso.com** のページの **[ツール]** メニューで **[PowerShell]** を選択してから、ダイアログが表示されたら、**Pa55w.rd** をパスワードとして **CONTOSO\\Administrator** ユーザーとしてサインインします。
1. **Windows PowerShell** コンソールで、次のコマンドを入力しから Enter キーを押して重複除去をトリガーします。

   ```powershell
   Start-DedupJob -Volume M: -Type Optimization –Memory 50
   ```
1. **SEA-SVR3** へのコンソール セッションに切り替えます。
1. **SEA-SVR3** の **Windows PowerShell** プロンプトで次のコマンドを入力して Enter キーを押し、重複除去されているボリューム上で使用可能な領域を確認します。

   ```powershell
   Get-PSDrive -Name M
   ```

   > **注**: 前に表示された値と現在の値を比較します。 

1. 5 から 10 分待って重複除去ジョブが完了したら、前の手順を繰り返します。
1. **SEA-ADM1** へのコンソール セッションに切り替えます。
1. **SEA-ADM1** の、**sea-svr3.contoso.com** への Windows Admin Center 接続が表示されている **Microsoft Edge** ウィンドウ内の **Windows PowerShell** コンソールで、次のコマンドを入力して Enter キーを押し、重複除去ジョブの状態を確認します。

   ```powershell
   Get-DedupStatus –Volume M: | fl
   Get-DedupVolume –Volume M: |fl
   Get-DedupMetadata –Volume M: |fl
   ```
1. **SEA-ADM1** で、**サーバー マネージャー**の [ディスク] ペインに切り替えてから、右上隅にある **[タスク]** メニューの **[最新の状態に更新]** を選択します。
1. **[ボリューム]** セクションで **M:** ボリュームを選択して状況依存メニューを表示し、メニューから **[プロパティ]** を選択します。 
1. **[ボリューム (M:\\) のプロパティ]** ウィンドウで、 **[重複除去率]** と **[重複除去による節約量]** の値を確認します。

## <a name="exercise-2-configuring-iscsi-storage"></a>演習 2: iSCSI 記憶域の構成

#### <a name="task-1-install-iscsi-and-configure-targets"></a>タスク 1: iSCSI をインストールしてターゲットを構成する

1. **SEA-ADM1** で、**Windows PowerShell** ウィンドウに切り替えます。
1. **Windows PowerShell** コンソールで、次のコマンドを入力して Enter キーを押して、**SEA-SVR3** への PowerShell リモート処理セッションを確立します。

   ```powershell
   Enter-PSSession -ComputerName SEA-SVR3
   ```
1. 次のコマンドを入力して Enter キーを押し、**SEA-SVR3** に iSCSI ターゲットをインストールします。

   ```powershell
   Install-WindowsFeature –Name FS-iSCSITarget-Server –IncludeManagementTools
   ```
1. 次のコマンドを入力してそのたびに Enter キーを押し、ディスク 2 に ReFS でフォーマットされた新しいボリュームを作成します。

   ```powershell
   Initialize-Disk -Number 2
   $partition2 = New-Partition -DiskNumber 2 -UseMaximumSize -AssignDriveLetter
   Format-Volume -DriveLetter $partition2.DriveLetter -FileSystem ReFS
   ```
1. 次のコマンドを入力してそのたびに Enter キーを押し、ディスク 3 に ReFS でフォーマットされた新しいボリュームを作成します。

   ```powershell
   Initialize-Disk -Number 3
   $partition3 = New-Partition -DiskNumber 3 -UseMaximumSize -AssignDriveLetter
   Format-Volume -DriveLetter $partition3.DriveLetter -FileSystem ReFS
   ```
1. 次のコマンドを入力してそのたびに Enter キーを押し、iSCSI トラフィックを許可するセキュリティが強化された Windows Defender ファイアウォール規則を構成します。

   ```powershell
   New-NetFirewallRule -DisplayName "iSCSITargetIn" -Profile "Any" -Direction Inbound -Action Allow -Protocol TCP -LocalPort 3260
   New-NetFirewallRule -DisplayName "iSCSITargetOut" -Profile "Any" -Direction Outbound -Action Allow -Protocol TCP -LocalPort 3260
   ```
1. 次のコマンドを入力して Enter キーを押し、新しく作成されたボリュームに割り当てられているドライブ文字を表示します。

   ```powershell
   $partition2.DriveLetter
   $partition3.DriveLetter
   ```

   > **注**: この手順では、ドライブ文字がそれぞれ **E** および **F** であるとしています。 ドライブ文字の割り当てが異なる場合は、この演習の手順に従うときにそれを考慮してください。

#### <a name="task-2-connect-to-and-configure-iscsi-targets"></a>タスク 2: iSCSI ターゲットに接続して構成する

1. **SEA-ADM1** で、**サーバー マネージャー**に切り替えます。
1. **SEA-ADM1** で、**サーバー マネージャー**の [ディスク] ペインに切り替えてから、右上隅にある **[タスク]** メニューの **[最新の状態に更新]** を選択します。
1. **サーバー マネージャー**のツリー ウィンドウで **[ファイル サービスと記憶域サービス]** の **[ディスク]** を選択し、右上隅にある **[タスク]** メニューの **[最新の状態に更新]** をクリックします。
1. ディスク 2 と 3 がオンラインになっている更新された **SEA-SVR3** のディスク構成を確認します。
1. **SEA-DC1** のエントリを参照し、ディスクの構成を確認します。

   > **注**: **SEA-DC1** には、ブートおよびシステム ボリュームをホストするディスクが 1 つだけあります。

1. **サーバー マネージャー**の **[ファイル サービスと記憶域サービス]** で、**[iSCSI]** を選択し、**[タスク]** を選択してから、ドロップダウン メニューで **[新しい iSCSI 仮想ディスク]** を選択します。
1. **新しい iSCSI 仮想ディスク ウィザード**の **[iSCSI 仮想ディスクの場所を選択]** ページで、**SEA-SVR3** サーバーの **E:** ボリュームを選択して、**[次へ]** を選択します。
1. **[iSCSI 仮想ディスク名の指定]** ページで、**[名前]** テキスト ボックスに「**iSCSIDisk1**」と入力し、**[次へ]** を選択します。
1. **[iSCSI 仮想ディスクのサイズを指定]** ページで、**[サイズ]** テキスト ボックスに「**5**」と入力します。 その他の設定はすべて既定値のままにして、**[次へ]** を選択します。
1. **[iSCSI ターゲットの割り当て]** ページで、**[新しい iSCSI ターゲット]** オプションが選択されていることを確認し、**[次へ]** を選択します。
1. **[ターゲット名の指定]** ページで、**[名前]** フィールドに「**iSCSIFarm**」と入力して、**[次へ]** を選択します。
1. **[アクセス サーバーの指定]** ページで、**[追加]** ボタンを選択します。
1. **[イニシエーターを識別する方法を選択してください]** ウィンドウで、**[参照]** ボタンを選択します。
1. **[コンピューターの選択]** ウィンドウで、**[選択するオブジェクト名を入力してください]** テキスト ボックスに「**SEA-DC1**」と入力し、**[名前の確認**] を選択して、**[OK]** を選択します。
1. **[イニシエーターを識別する方法を選択してください]** ウィンドウで、**[OK]** を選択します。
1. **[アクセス サーバーの指定]** ページで、**[次へ]** を選択します。
1. **[認証を有効にする]** ページで、**[次へ]** を選択します。
1. **[選択内容の確認]** ページで、**[作成]** を選択します。
1. **[結果の表示]** ページで、**[閉じる]** を選択します。
1. 既存の iSCSI ターゲットを選択してステップ 6 から 9 を繰り返し、次の設定を使用してステップ 18 から 19 を実行してウィザードを完了し、2 番目の iSCSI 仮想ディスク (F:) を作成します。

   - 記憶域の場所: **F:**
   - 名前: **iSCSIDisk2**
   - ディスク サイズ: **5 GB**、**可変容量**
   - iSCSI ターゲット: **iSCSIFarm**

1. **SEA-DC1** のコンソール セッションに切り替え、必要に応じて、**Pa55w.rd** のパスワードを使用して **CONTOSO\\Administrator** としてサインインします。
1. **SConfig** のメニューが表示された場合は、**[選択するオプションの番号を入力してください]** で「**15**」と入力して Enter キーを押し、終了して **PowerShell** コンソール セッションに移動します。
1. **Windows PowerShell** のプロンプトで次のコマンドを入力し、それぞれの後で Enter キーを押して、iSCSI イニシエーター サービスを開始し、iSCSI イニシエーターの構成を表示します。

   ```powershell
   Start-Service -Name MSiSCSI
   iscsicpl
   ```

   > **注**: **iscsicpl** コマンドを実行すると、**[iSCSI イニシエーターのプロパティ]** ウィンドウが開きます。

1. **SEA-DC1** の **[iSCSI イニシエーターのプロパティ]** ダイアログ ボックスで、**[ターゲット]** タブの **[ターゲット]** テキスト ボックスに「**SEA-SVR3.contoso.com**」と入力して、**[クイック接続]** を選択します。
1. **[クイック接続]** ダイアログ ボックスで、**[Discovered target name]\(検出されたターゲット名\)** が **iqn.1991-05.com.microsoft:sea-svr3-iscscifarm-target** であることを確認し、**[完了]** を選択します。
1. **[iSCSI イニシエーターのプロパティ]** ダイアログ ボックスで、**[OK]** を選択します。

#### <a name="task-3-verify-iscsi-disk-configuration"></a>タスク 3: iSCSI ディスクの構成を確認する

1. **[サーバー マネージャー]** ウィンドウをアクティブにして **SEA-ADM1** へのコンソール セッションに戻ります。
1. **サーバー マネージャー**で **[ファイル サービスと記憶域サービス]** の [iSCSI] ウィンドウから [ディスク] ウィンドウに切り替え、右上隅の **[タスク]** メニューで **[最新の状態に更新]** を選択します。 
1. **SEA-DC1** ディスクの構成を確認し、2 つの **5 GB** ディスクが含まれ、**オフライン**状態であり、バスの種類が **iSCSI** であることを確認します。
1. **SEA-DC1** のコンソール セッションに切り替えます。 
1. **Windows PowerShell** プロンプトで、次のコマンドを入力して Enter キーを押し、ディスク構成の一覧を表示します。

   ```powershell
   Get-Disk
   ```

   > **注**: 両方のディスクが存在し、正常ですが、オフラインです。 それらを使用するには、初期化してフォーマットする必要があります。

1. 次のコマンドを入力してそれぞれの後で Enter キーを押し、ReFS でフォーマットされたドライブ文字 **E** のボリュームを作成します。

   ```powershell
   Initialize-Disk -Number 1
   New-Partition -DiskNumber 1 -UseMaximumSize -DriveLetter E
   Format-Volume -DriveLetter E -FileSystem ReFS
   ```
1. 前のステップを繰り返して、ReFS でフォーマットされた新しいドライブを作成しますが、今回はディスク番号 **2** とドライブ文字 **F** を使用します。
1. **[サーバー マネージャー]** ウィンドウをアクティブにして **SEA-ADM1** へのコンソール セッションに戻ります。
1. **サーバー マネージャー** ウィンドウの右上隅にある **[タスク]** メニューの **[最新の状態に更新]** を選択して、**[ファイル サービスと記憶域サービス]** の [ディスク] ペインを更新します。 
1. **SEA-DC1** ディスクの構成を確認し、両方のドライブが**オンライン**になっていることを確認します。

#### <a name="task-4-revert-disk-configuration"></a>タスク 4: ディスクの構成を元に戻す 

1. **SEA-SVR3** へのコンソール セッションに切り替えます。
1. **Windows PowerShell** プロンプトで次のコマンドを入力してそれぞれの後で Enter キーを押し、**SEA-SVR3** のディスクを元の状態にリセットします (**Clear-Disk** コマンドレットの実行確認を求めるメッセージが表示されたら、各ループの繰り返しの前に **Y** キーを押して Enter キーを押します)。

   ```powershell
   for ($num = 1;$num -le 4; $num++) {Clear-Disk -Number $num -RemoveData -RemoveOEM -ErrorAction SilentlyContinue}
   for ($num = 1;$num -le 4; $num++) {Set-Disk -Number $num -IsOffline $true}
   ```

   > **注**: これは、次の演習に備えるために必要です。

## <a name="exercise-3-configuring-redundant-storage-spaces"></a>演習 3: 冗長記憶域スペースの構成

#### <a name="task-1-create-a-storage-pool"></a>タスク 1: 記憶域プールを作成する

1. **[サーバー マネージャー]** ウィンドウをアクティブにして **SEA-ADM1** へのコンソール セッションに戻ります。
1. **サーバー マネージャー** ウィンドウの右上隅にある **[タスク]** メニューの **[最新の状態に更新]** を選択して、**[ファイル サービスと記憶域サービス]** の [ディスク] ペインを更新します。 
1. [ディスク] ペインで下にスクロールし、**SEA-SVR3** のディスク 1 から 4 が **[不明]** パーティションおよび **[オフライン]** 状態で一覧表示されることを確認します。 
1. 4 つのディスクを順に選択して状況依存メニューを表示して、メニューの **[オンラインにする]** オプションを選択してから、**[ディスクをオンラインにする]** ウィンドウで **[はい]** を選択します。
1. すべてのディスクが **[オンライン]** 状態で一覧に表示されていることを確認します。 **サーバー マネージャー**のナビゲーション ウィンドウで、**[記憶域プール]** を選択します。
1. **サーバー マネージャー**の **[記憶域プール]** 領域で、**[タスク]** の一覧の **[記憶域プールの新規作成]** を選択します。 
1. **記憶域プールの新規作成ウィザード**の **[開始する前に]** ページで、**[次へ]** を選択します。
1. **[記憶域プールの名前とサブシステムの指定]** ページの **[名前]** テキスト ボックスに「**SP1**」と入力します。 **[説明]** テキスト ボックスに、「**記憶域プール 1**」と入力します。 **[使用する利用可能なディスクのグループ (ルート プール) を選択してください]** の一覧で **SEA-SVR3** のエントリを選択し、**[次へ]** を選択します。
1. **[記憶域プールの物理ディスクを選択]** ページで、3 つのディスクの **127 GB** サイズの横にあるチェック ボックスをオンにして、**[次へ]** を選択します。
1. **[選択内容の確認]** ページで設定を確認し、**[作成]** を選択します。
1. **[閉じる]** を選択します。

#### <a name="task-2-create-a-volume-based-on-a-three-way-mirrored-disk"></a>タスク 2: 3 方向ミラー ディスクを基にしてボリュームを作成する 

1. **SEA-ADM1** の**サーバー マネージャー**の [記憶域プール] ペインで、**SP1** を選択します。
1. **[仮想ディスク]** 領域で **[タスク]** を選択し、**[仮想ディスクの新規作成]** を選択します。
1. **[記憶域プールの選択]** ダイアログ ボックスで **SP1** を選択して、**[OK]** を選択します。
1. **仮想ディスクの新規作成ウィザード**の **[開始する前に]** ページで、**[次へ]** を選択します。
1. **[仮想ディスク名の指定]** ページで、**[名前]** テキスト ボックスに「**Three-Mirror**」と入力し、**[次へ]** を選択します。
1. **[エンクロージャの回復性の指定]** ページで、**[次へ]** を選択します。
1. **[記憶域のレイアウトの選択]** ページで **[ミラー]** を選択して、 **[次へ]** を選択します。
1. **[プロビジョニング型の指定]** ページで **[仮想]** を選択して、 **[次へ]** を選択します。
1. **[仮想ディスクのサイズの指定]** ページの **[サイズの指定]** テキスト ボックスに「**25**」と入力して、**[次へ]** を選択します。
1. **[選択内容の確認]** ページで設定を確認し、**[作成]** を選択します。
1. **[結果の表示]** ページで、**[Create a volume when this wizard closes]\(このウィザードが閉じるときにボリュームを作成する\)** チェック ボックスをオフにして、**[閉じる]** を選択します。
1. **サーバー マネージャー**のナビゲーション ウィンドウで、**[ボリューム]** エントリが選択されていることを確認します。
1. **[ボリューム]** 領域で **[タスク]** を選択し、**[ボリュームの新規作成]** を選択します。
1. **新しいボリューム ウィザード**の **[開始する前に]** ページで、**[次へ]** を選択します。
1. **[サーバーとディスクの選択]** ページで、**SEA-SVR3** と **Three-Mirror** を選択して、**[次へ]** を選択します。
1. **[ボリューム サイズの指定]** ページで、**[次へ]** を選択します。
1. **[ドライブ文字またはフォルダーへの割り当て]** ページで、**[ドライブ文字]** を選択し、**T** を選択して、**[次へ]** を選択します。
1. **[ファイル システム形式の選択]** ページで、**[ファイル システム]** ドロップダウン リストの **[ReFS]** を選択します。 **[ボリューム ラベル]** テキスト ボックスに「**TestData**」と入力して、**[次へ]** を選択します。
1. **[データ重複除去を有効にする]** ページで、**[次へ]** を選択します。
1. **[選択内容の確認]** ページで、**[作成]** を選択します。
1. **[完了]** ページで **[閉じる]** を選択します。

#### <a name="task-3-manage-a-volume-in-file-explorer"></a>タスク 3: エクスプローラーでボリュームを管理する

1. **SEA-ADM1** で、**SEA-SVR3** への PowerShell リモート処理セッションをホストしている **Windows PowerShell** に切り替えます。
1. **Windows PowerShell** コンソールの **[SEA-SVR3]** プロンプトで、次のコマンドを入力して Enter キーを押し、セキュリティが強化された Windows Defender ファイアウォールのすべてのファイルとプリンターの共有規則を有効にします。

   ```powershell
   Enable-NetFirewallRule -Group "@FirewallAPI.dll,-28502"
   ```

1. **SEA-ADM1** のタスク バーで、**エクスプローラー** アイコンを選択します。
1. **エクスプローラー** ウィンドウの**アドレス バー**に「**\\\\SEA-SVR3.contoso.com\\t$**」と入力します。
1. エクスプローラーの [詳細] ペインで状況依存メニューを表示し、メニューの **[新規フォルダー]** を選択します。 新しいフォルダーに割り当てられた既定の名前を **TestData** に置き換えて、Enter キーを押します。
1. エクスプローラーで、新しく作成した **TestData** フォルダーをダブルクリックします。
1. エクスプローラーの [詳細] ペインで状況依存メニューを表示し、メニューの **[新規]** を選択して、**[テキスト ドキュメント]** を選択します。 新しいファイルに割り当てられた既定の名前を **TestDocument** に置き換えて、Enter キーを押します。

#### <a name="task-4-disconnect-a-disk-from-the-storage-pool-and-verify-volume-availability"></a>タスク 4: 記憶域プールからディスクを切断し、ボリュームの可用性を確認する 

1. **SEA-ADM1** で、**サーバー マネージャー**に切り替えます。 **[ファイル サービスと記憶域サービス]** のツリー ペインで、**[記憶域プール]** を選択してから、**SP1** を選択します。
1. [物理ディスク] ペインで、**[タスク]** ドロップダウン リストを選択し、**[物理ディスクの追加]** を選択します。
1. **[物理ディスクの追加]** ダイアログ ボックスの、プールに追加する 4 番目のディスクを表す行で、ディスク名の横にあるチェック ボックスをオンにします。 **[割り当て]** ドロップダウン リストで、**[自動]** エントリが選択されていることを確認し、**[OK]** を選択します。
1. [物理ディスク] ペインで、一覧の先頭のディスクを右クリックして、**[ディスクの削除]** を選択します。
1. **[物理ディスクの削除]** ウィンドウで、**[はい]** を選択します。
1. **[物理ディスクの削除]** ダイアログ ボックスで、**影響を受ける仮想ディスクを Windows が修復している**ことを示すメッセージを確認して、**[OK]** を選択します。
1. **TestData** フォルダーの内容が表示されている**エクスプローラー** ウィンドウに戻ります。
1. **TestDocument.txt** を開き、その内容がまだ使用可能な状態であることを確認します。

#### <a name="task-5-add-a-disk-to-the-storage-pool-and-verify-volume-availability"></a>タスク 5: 記憶域プールにディスクを追加し、ボリュームの可用性を確認する 

1. **SEA-ADM1** で、**サーバー マネージャー**に切り替えます。 **[ファイル サービスと記憶域サービス]** ツリー ペインの **[記憶域プール]** エントリを選択し、右上隅の **[タスク]** メニューで **[記憶域の再スキャン]** を選択します。
1. プロンプトが表示されたら、**[記憶域の再スキャン]** ダイアログ ボックスで **[はい]** を選択します。
1. [物理ディスク] ペインで **[タスク]** を選択し、ドロップダウン メニューの **[物理ディスクの追加]** を選択します。
1. **[物理ディスクの追加]** ウィンドウの、プールに追加する 4 番目のディスクを表す行で、ディスク名の横にあるチェック ボックスをオンにします。 **[割り当て]** ドロップダウン リストで、**[自動]** エントリが選択されていることを確認し、**[OK]** を選択します。
1. **SEA-ADM1** で **エクスプローラー** ウィンドウに切り替えて、**TestData** フォルダーとその内容がまだ使用可能な状態であることを確認します。

#### <a name="task-6-revert-disk-configuration"></a>タスク 6: ディスクの構成を元に戻す 

1. **SEA-SVR3** へのコンソール セッションに切り替えます。
1. **Windows PowerShell** プロンプトで次のコマンドを入力してそれぞれの後で Enter キーを押し、**SEA-SVR3** のディスクを元の状態にリセットします (**Remove-VirtualDisk**、**Remove-StoragePool**、**Clear-Disk** の各コマンドレットの実行確認を求めるメッセージが表示されたら、**Y** キーを押して Enter キーを押し、各コマンドレットを実行します)。

   ```powershell
   Get-VirtualDisk -FriendlyName 'Three-Mirror' | Remove-VirtualDisk
   Get-StoragePool -FriendlyName 'SP1' | Remove-StoragePool
   for ($num = 1;$num -le 4; $num++) {Clear-Disk -Number $num -RemoveData -RemoveOEM -ErrorAction SilentlyContinue}
   for ($num = 1;$num -le 4; $num++) {Set-Disk -Number $num -IsOffline $true}
   ```

   > **注**: これは、次の演習に備えるために必要です。

## <a name="exercise-4-implementing-storage-spaces-direct"></a>演習 4: 記憶域スペース ダイレクトの実装

#### <a name="task-1-prepare-for-installation-of-storage-spaces-direct"></a>タスク 1: 記憶域スペース ダイレクトのインストールを準備する 

1. **SEA-ADM1** へのコンソール セッションに戻り、**[すべてのサーバー]** を選択します。
1. **SEA-ADM1** の**サーバー マネージャー**のコンソール ツリーで、**[すべてのサーバー]** を選択し、**SEA-SVR1**、**SEA-SVR2**、**SEA-SVR3** の **[管理状態]** が **[オンライン - パフォーマンス カウンターが開始されていません]** 状態であることを確認してから、次に進みます。
1. **サーバー マネージャー**のナビゲーション ウィンドウで、**[ファイル サービスと記憶域サービス]** を選択し、**[ディスク]** を選択します。
1. [ディスク] ペインが選択された状態で、右上隅の **[タスク]** メニューの **[最新の状態に更新]** を選択します。
1. [ディスク] ペインで、**SEA-SVR3** のディスク 1 から 4 の一覧まで下にスクロールし、**[パーティション]** 列のそれぞれのエントリが **[不明]** と表示されていることを確認します。
1. 4 つのディスクを順番に選択し、状況依存メニューを表示します。 メニューで **[オンラインにする]** オプションを選択し、**[ディスクをオンラインにする]** ウィンドウで **[はい]** を選択します。
1. 同じ方法を使用して、**SEA-SVR1** と **SEA-SVR2** のすべてのディスクをオンラインにします。
1. **SEA-ADM1** で **[スタート]** を選択し、**[スタート]** メニューの **[Windows PowerShell ISE]** を選択します。
1. **Windows PowerShell ISE** で、**[ファイル]** メニューを選択します。 **[ファイル]** メニューの **[開く]** を選択し、**[開く]** ダイアログ ボックスで **C:\Labfiles\Lab09** に移動します。
1. **Implement-StorageSpacesDirect.ps1** を選択して、**[開く]** を選択します。

   > **注**: スクリプトは、番号付きのステップに分かれています。 8 つのステップがあり、各ステップには多数のコマンドがあります。 個々の行を実行するには、その行のどこかにカーソルを置いて、F8 キーを押すか、**Windows PowerShell ISE** ウィンドウのツール バーで **[選択項目を実行]** を選択します。 複数の行を実行するには、それらすべての全体を選択して、F8 キーまたは **[選択項目を実行]** ツール バー アイコンを使用します。 一連の手順については、この演習の手順で説明されています。 各ステップが完了したことを確認してから、次のステップを始めます。

1. ステップ 1 の最初の行を選択し、F8 キーを押して、**SEA-SVR1**、**SEA-SVR2**、**SEA-SVR3** に**ファイル サーバーの役割とフェールオーバー クラスタリング**機能をインストールします。

   > **注**: インストールが完了するまで待ちます。 これには 2 分ほどかかります。 各コマンドの出力で、**Success** プロパティが **True** に設定されていることを確認します。

1. ステップ 1 の 2 行目を選択し、F8 キーを押して **SEA-SVR1**、**SEA-SVR2**、**SEA-SVR3** を再起動します。

   > **注**: 2 番目のコマンドを呼び出してサーバーを再起動したら、再起動が完了するのを待たずに、3 番目のコマンドを実行して、フェールオーバー クラスタリング管理ツールをインストールできます。

1. ステップ 1 の **Install** で始まる 3 行目を選択し、F8 キーを押して、**フェールオーバー クラスター マネージャー** ツールを **SEA-ADM1** にインストールします。

   > **注**: サーバーが再起動し、**フェールオーバー クラスター マネージャー** ツールが **SEA-ADM1** にインストールされるまで、数分待ちます。

#### <a name="task-2-create-and-validate-a-failover-cluster"></a>タスク 2: フェールオーバー クラスターを作成して検証する 

1. **SEA-ADM1** で、**[サーバー マネージャー]** ウィンドウに切り替えます。
1. **サーバー マネージャー**で **[ツール]** を選択し、**[フェールオーバー クラスター マネージャー]** を選択して、インストールが正常に完了したことを確認します。
1. **SEA-ADM1** で **[管理者: Windows PowerShell ISE]** ウィンドウに切り替えて、ステップ 2 の **Test-Cluster** で始まる行を選択し、F8 キーを押してクラスター検証テストを起動します。

   > **注**: テストが完了するまで待ちます。 これには 2 分ほどかかります。 テストが失敗していないことを確認します。 警告は、想定されているため無視します。 

1. **[管理者: Windows PowerShell ISE]** ウィンドウで、ステップ 3 の **New-Cluster** で始まる行を選択し、F8 キーを押してクラスターを作成します。

   > **注**: ステップが完了するまで待ちます。 これには 2 分ほどかかります。 

1. **SEA-ADM1** で、**[フェールオーバー クラスター マネージャー]** ウィンドウに切り替えます。 [操作] ペインで **[クラスターに接続する]** を選択し、「**S2DCluster.Contoso.com**」と入力して、**[OK]** を選択します。

#### <a name="task-3-enable-storage-spaces-direct"></a>タスク 3: 記憶域スペース ダイレクトを有効にする

1. **SEA-ADM1** で **[管理者: Windows PowerShell ISE]** ウィンドウに切り替え、ステップ 4 の **Invoke-Command** で始まる行を選択してから、F8 キーを押して、新しくインストールしたクラスターで記憶域スペース ダイレクトを有効にします。

   > **注**: ステップが完了するまで待ちます。 これには 1 分ほどかかります。

1. **[管理者: Windows PowerShell ISE]** ウィンドウで、ステップ 5 の **Invoke-Command** で始まる行を選択し、F8 キーを押して **S2DStoragePool** を作成します。

   > **注**: ステップが完了するまで待ちます。 これにかかる時間は 1 分未満です。 コマンドの出力で、**FriendlyName** 属性の値が **S2DStoragePool** であることを確認します。

1. **[フェールオーバー クラスター マネージャー]** ウィンドウに切り替え、**S2DCluster.Contoso.com**、**[記憶域]** の順に展開して、**[プール]** を選択します。
1. **クラスター プール 1** が存在することを確認します。
1. **[管理者: Windows PowerShell ISE]** ウィンドウで、ステップ 6 の **Invoke-Command** で始まる行を選択し、F8 キーを押して仮想ディスクを作成します。

   > **注**: ステップが完了するまで待ちます。 これにかかる時間は 1 分未満です。 

1. **[フェールオーバー クラスター マネージャー]** ウィンドウに切り替えて、**[記憶域]** ノードで **[ディスク]** を選択します。
1. **[クラスター仮想ディスク (CSV)]** が存在することを確認します。

#### <a name="task-4-create-a-storage-pool-a-virtual-disk-and-a-share"></a>タスク 4: 記憶域プール、仮想ディスク、共有を作成する

1. **[管理者: Windows PowerShell ISE]** ウィンドウで、ステップ 7 の **Invoke-Command** で始まる行を選択し、F8 キーを押してファイル サーバー クラスターの役割を作成します。

   > **注**: ステップが完了するまで待ちます。 これにかかる時間は 1 分未満です。 

1. コマンドの出力に、属性 **FriendlyName** が **S2D-SOFS** に設定された役割の定義が含まれていることを確認します。 これは、コマンドが成功したことを示します。
1. **[フェールオーバー クラスター マネージャー]** ウィンドウに切り替えて、**[役割]** を選択します。
1. 役割 S2D-SOFS が存在することを確認します。 これは、コマンドが正常に完了したことも示します。
1. **[管理者: Windows PowerShell ISE]** ウィンドウで、ステップ 8 の **Invoke-Command** で始まる 3 つの行を選択し、F8 キーを押してファイル共有を作成します。

   > **注**: ステップが完了するまで待ちます。 これにかかる時間は 1 分未満です。 

1. コマンドの出力に、属性 **Path** が **C:\\ClusterStorage\\CSV\\VM01** に設定されたファイル共有の定義が含まれていることを確認します。 これは、コマンドが正常に完了したことを示します。
1. **[フェールオーバー クラスター マネージャー]** ウィンドウの **[役割]** ウィンドウで、 **[名前]** 列の下にある **[S2D-SOFS]** を選択し、 **[共有]** タブを選択します。
1. **VM01** という名前の共有が存在することを確認します。 これは、コマンドが正常に完了したことも示します。

#### <a name="task-5-verify-storage-spaces-direct-functionality"></a>タスク 5: 記憶域スペース ダイレクトの機能を確認する

1. **SEA-ADM1** のタスク バーで、**エクスプローラー** アイコンを選択します。
1. **エクスプローラー**のアドレス バーに「**\\\\S2D-SOFS.contoso.com\\VM01**」と入力し、Enter キーを押して、ターゲットのファイル共有を開きます。
1. **エクスプローラー**の詳細ペインで状況依存メニューを表示し、メニューの **[新規フォルダー]** を選択します。 新しいフォルダーに割り当てられた既定の名前を **VMFolder** に置き換えて、Enter キーを押します。
1. **SEA-ADM1** で、**[管理者: Windows PowerShell ISE]** ウィンドウに切り替えます。
1. **[管理者: Windows PowerShell ISE]** ウィンドウのコンソール ペインで、次のコマンドを入力して Enter キーを押し、**SEA-SVR3** をシャットダウンします。

   ```powershell
   Stop-Computer -ComputerName SEA-SVR3 -Force
   ```

1. **SEA-ADM1** で **[サーバー マネージャー]** ウィンドウに切り替えて、**[すべてのサーバー]** を選択し、右上隅にある **[タスク]** メニューの **[最新の状態に更新]** を選択します。
1. **SEA-SVR3** のエントリの **[管理状態]** 列が **[ターゲット コンピューターにアクセスできません]** となっていることを確認します。
1. **[エクスプローラー]** ウィンドウに戻り、**VMFolder** にまだアクセスできることを確認します。
1. **フェールオーバー クラスター マネージャー**に切り替えて、**[ディスク]** を選択し、**[クラスター仮想ディスク (CSV)]** を選択します。
1. **[クラスター仮想ディスク (CSV)]** で、**[正常性状態]** が **[警告]** に設定され、**[動作状態]** が **[低下]** に設定されていることを確認します (**[動作状態]** は **[不完全]** になっている場合もあります)。
1. **SEA-ADM1** で、Windows Admin Center が表示されている **Microsoft Edge** ウィンドウに切り替えます。 
1. [すべての接続] ペインを参照し、 **[+ 追加]** を選択します。
1. **[リソースの追加または作成]** ペインの **[サーバー クラスター]** ペインで、 **[追加]** を選択します。
1. **[クラスター名]** テキスト ボックスに、「**S2DCluster.Contoso.com**」と入力します。
1. **[Use another account for this connection]\(この接続に別のアカウントを使用する\)** オプションが選択されていることを確認し、次の資格情報を入力して、**[Connect with account]\(アカウントを使用して接続\)** を選択します。

   - ユーザー名: **CONTOSO\\Administrator**
   - パスワード: **Pa55w.rd**
   
1. **[クラスターにサーバーも追加する]** をオフにして、 **[追加]** を選択します。
1. **[すべての接続]** ページに戻り、**s2dcluster.contoso.com** を選択します。
1. ページが読み込まれると、[ダッシュボード] ペインに **SEA-SVR3** に到達できないことを示す警告が表示されることを確認します。 
1. **SEA-SVR3** へのコンソール セッションに切り替えて、それを開始します。 

   > **注**: 警告が自動的に消えるまで数分かかる場合があります。

1. Windows Admin Center が表示されているブラウザー ページを更新し、すべてのサーバーが正常であることを確認します。
